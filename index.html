<!DOCTYPE html>
<html lang="ru" data-version="v7">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Калькулятор</title>
  <link rel="manifest" href="manifest.json?v=7">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icons/icon-192.png?v=7">
  <style>
    :root{
      --bg:#000; --text:#fff; --display-bg:#000;
      --btn-num:#333333; --btn-fn:#a5a5a5; --btn-op:#ff9f0a;
      --btn-num-text:#fff; --btn-fn-text:#000; --btn-op-text:#fff;
      --gap:8px; --pad:12px; --btn:72px;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-tap-highlight-color:transparent;
    }
    .app{
      height:100svh;
      padding: calc(env(safe-area-inset-top)) calc(env(safe-area-inset-right) + var(--pad)) calc(env(safe-area-inset-bottom) + var(--pad)) calc(env(safe-area-inset-left) + var(--pad));
      display:flex; flex-direction:column; margin:0 auto; max-width:980px;
    }
    .display{
      flex:1; background:var(--display-bg);
      display:flex; align-items:flex-end; justify-content:flex-end;
      padding: 0 8px; font-weight:300; overflow:hidden; user-select:none;
    }
    .portrait-grid{
      display:grid; gap:var(--gap);
      grid-template-columns: repeat(4, 1fr);
    }
    .landscape-wrap{ display:none; gap:var(--gap); }
    .landscape-grid{
      display:grid; gap:var(--gap);
      grid-template-columns: repeat(8, 1fr); /* 4 sci + 4 main */
    }
    .sci-grid{ display:grid; gap:var(--gap); grid-template-columns: repeat(4, 1fr); }
    .main-grid{ display:grid; gap:var(--gap); grid-template-columns: repeat(4, 1fr); }
    button{
      border:none; border-radius:50%;
      width:var(--btn); height:var(--btn);
      font-size: calc(var(--btn) * 0.36);
      line-height:1; display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .fn{ background:var(--btn-fn); color:var(--btn-fn-text); }
    .op{ background:var(--btn-op); color:var(--btn-op-text); }
    .num{ background:var(--btn-num); color:var(--btn-num-text); }
    .chip{ height:36px; border-radius:10px; padding:0 12px; font-size:14px; display:inline-flex; align-items:center; }
    .chip.on{ background:#34c759; color:#000; } .chip.off{ background:#3a3a3c; color:#fff; }

    /* Landscape only block */
    @media (orientation: landscape){
      .portrait-grid{ display:none; }
      .landscape-wrap{ display:grid; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div id="display" class="display" aria-live="polite">0</div>

    <!-- PORTRAIT (standard 4x5) -->
    <div class="portrait-grid" id="portraitGrid" role="group" aria-label="Кнопки калькулятора (портрет)">
      <button class="fn" data-action="clear">AC</button>
      <button class="fn" data-action="sign">±</button>
      <button id="percentP" class="fn" data-action="percent">%</button>
      <button class="op" data-op="÷">÷</button>

      <button class="num" data-num="7">7</button>
      <button class="num" data-num="8">8</button>
      <button class="num" data-num="9">9</button>
      <button class="op" data-op="×">×</button>

      <button class="num" data-num="4">4</button>
      <button class="num" data-num="5">5</button>
      <button class="num" data-num="6">6</button>
      <button class="op" data-op="−">−</button>

      <button class="num" data-num="1">1</button>
      <button class="num" data-num="2">2</button>
      <button class="num" data-num="3">3</button>
      <button class="op" data-op="+">+</button>

      <button class="num" data-num="0">0</button>
      <button class="num" data-num=".">.</button>
      <button class="op" data-op="=">=</button>
      <div></div>
    </div>

    <!-- LANDSCAPE (iOS-like: sci left, main right) -->
    <div class="landscape-wrap">
      <div class="landscape-grid">
        <!-- LEFT: SCIENTIFIC 4x5 -->
        <div class="sci-grid" id="sciGrid" aria-label="Инженерные функции (слева)">
          <button class="fn" data-fn="2nd">2nd</button>
          <button class="fn" data-fn="deg">DEG</button>
          <button class="fn" data-fn="ln">ln</button>
          <button class="fn" data-fn="log">log</button>

          <button class="fn" data-fn="sin">sin</button>
          <button class="fn" data-fn="cos">cos</button>
          <button class="fn" data-fn="tan">tan</button>
          <button class="fn" data-fn="pow2">x²</button>

          <button class="fn" data-fn="asin">sin⁻¹</button>
          <button class="fn" data-fn="acos">cos⁻¹</button>
          <button class="fn" data-fn="atan">tan⁻¹</button>
          <button class="fn" data-fn="sqrt">√x</button>

          <button class="fn" data-fn="pi">π</button>
          <button class="fn" data-fn="e">e</button>
          <button class="fn" data-fn="pow">xʸ</button>
          <button class="fn" data-fn="cbrt">∛x</button>

          <button class="fn" data-fn="lparen">(</button>
          <button class="fn" data-fn="rparen">)</button>
          <button class="fn" data-fn="inv">1/x</button>
          <button class="fn" data-fn="fact">x!</button>
        </div>

        <!-- RIGHT: MAIN 4x5 (iPhone-like) -->
        <div class="main-grid" id="mainGrid" role="group" aria-label="Кнопки калькулятора (справа)">
          <button class="fn" data-action="clear">AC</button>
          <button class="fn" data-action="sign">±</button>
          <button id="percentL" class="fn" data-action="percent">%</button>
          <button class="op" data-op="÷">÷</button>

          <button class="num" data-num="7">7</button>
          <button class="num" data-num="8">8</button>
          <button class="num" data-num="9">9</button>
          <button class="op" data-op="×">×</button>

          <button class="num" data-num="4">4</button>
          <button class="num" data-num="5">5</button>
          <button class="num" data-num="6">6</button>
          <button class="op" data-op="−">−</button>

          <button class="num" data-num="1">1</button>
          <button class="num" data-num="2">2</button>
          <button class="num" data-num="3">3</button>
          <button class="op" data-op="+">+</button>

          <button class="num" data-num="0">0</button>
          <button class="num" data-num=".">.</button>
          <button class="op" data-op="=">=</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const root = document.documentElement;
  const app = document.getElementById('app');
  const displayEl = document.getElementById('display');
  const portraitGrid = document.getElementById('portraitGrid');
  const sciGrid = document.getElementById('sciGrid');
  const mainGrid = document.getElementById('mainGrid');

  function px(n){ return Math.max(0, Math.floor(n)) + 'px'; }

  function layout(){
    const gap = 8, pad = 12;
    const W = app.clientWidth - pad*2;
    const H = app.clientHeight - pad*2;
    const isLand = matchMedia('(orientation: landscape)').matches;
    if (!isLand){
      const cols = 4, rows = 5;
      const btnW = (W - gap*(cols-1)) / cols;
      const btnH = (H - (H*0.32) - gap*(rows-1)) / rows;
      const btn = Math.max(52, Math.min(btnW, btnH));
      root.style.setProperty('--btn', px(btn));
      displayEl.style.fontSize = px(Math.min(76, Math.max(36, btn*0.8)));
    } else {
      const cols = 8, rows = 5;
      const btnW = (W - gap*(cols-1)) / cols;
      const displayH = Math.max(48, Math.min(H*0.22, 90));
      const btnH = (H - displayH - gap*(rows-1)) / rows;
      const btn = Math.max(48, Math.min(btnW, btnH));
      root.style.setProperty('--btn', px(btn));
      displayEl.style.fontSize = px(Math.min(64, Math.max(30, btn*0.75)));
    }
  }
  addEventListener('resize', layout, {passive:true});
  addEventListener('orientationchange', ()=> setTimeout(layout, 50));
  addEventListener('load', layout);

  // Logic
  const percentP = document.getElementById('percentP');
  const percentL = document.getElementById('percentL');

  let current='0', stored=null, lastOp=null, justEvaluated=false, ans=0;
  let focusMode=false, deg=true, second=false;

  function updateDisplay(text){ displayEl.textContent = (text!==undefined)?text:current; }
  function inputDigit(d){ if (justEvaluated){ current='0'; justEvaluated=false; } if(d==='.') { if(!current.includes('.')) current+='.'; } else { current=(current==='0')?String(d):current+String(d); } updateDisplay(); }
  function clearAll(){ current='0'; stored=null; lastOp=null; justEvaluated=false; updateDisplay(); }
  function setSign(){ if(current.startsWith('-')) current=current.slice(1); else if(current!=='0') current='-'+current; updateDisplay(); }
  function percent(){ current=String(parseFloat(current||'0')/100); updateDisplay(); }
  function evalPair(a,b,op){ switch(op){case '+':return a+b;case '−':return a-b;case '×':return a*b;case '÷':return b===0?NaN:a/b;default:return b;} }
  function chainOrStore(op){ if(stored===null){ stored=parseFloat(current); current='0'; } else { const a=stored,b=parseFloat(current); stored=evalPair(a,b,lastOp||op); current='0'; } lastOp=op; }
  function evaluate(){ if(lastOp!==null){ const a=stored,b=parseFloat(current); const res=evalPair(a,b,lastOp); ans=res; current=String(res); stored=null; lastOp=null; justEvaluated=true; updateDisplay(); } else { justEvaluated=true; ans=parseFloat(current); } }

  function pad2(n){ return String(n).padStart(2,'0'); }
  function focusStringNow(){ const t=new Date(); return pad2(t.getMinutes())+pad2(t.getSeconds())+pad2(t.getHours())+pad2(t.getMonth()+1)+String(t.getFullYear()); }

  let pctCount=0,pctTimer=null;
  function onPercentTap(){
    pctCount++;
    if(!pctTimer){
      pctTimer=setTimeout(()=>{
        if(pctCount>=5){
          focusMode=!focusMode;
          updateDisplay(focusMode?'FOCUS ON':'FOCUS OFF'); setTimeout(()=>updateDisplay(),700);
        } else { percent(); }
        pctCount=0; pctTimer=null;
      }, 1200);
    }
  }
  percentP.addEventListener('click', onPercentTap);
  percentL.addEventListener('click', onPercentTap);

  function onEquals(){ if(focusMode){ current=focusStringNow(); stored=null; lastOp=null; justEvaluated=true; updateDisplay(); } else { evaluate(); } }

  function wireGrid(container){
    container.querySelectorAll('button').forEach(btn=>{
      const num=btn.dataset.num,op=btn.dataset.op,action=btn.dataset.action;
      if(num!==undefined){ btn.addEventListener('click',()=>inputDigit(num)); }
      else if(action){
        if(action==='clear') btn.addEventListener('click',clearAll);
        if(action==='sign') btn.addEventListener('click',setSign);
      } else if(op){
        if(op==='=') btn.addEventListener('click',onEquals);
        else btn.addEventListener('click',()=>chainOrStore(op));
      }
    });
  }
  wireGrid(portraitGrid);
  wireGrid(mainGrid);

  function toRad(x){ return deg?x*Math.PI/180:x; } function fromRad(x){ return deg?x*180/Math.PI:x; }
  function factorial(n){ n=Math.floor(n); if(n<0) return NaN; let r=1; for(let i=2;i<=n;i++) r*=i; return r; }
  function setCurrent(v){ current=String(v); justEvaluated=true; updateDisplay(); }
  function inputConst(v){ if(current==='0' || justEvaluated){ current=String(v); justEvaluated=false; } else { current+=String(v);} updateDisplay(); }

  const sciActions = {
    '2nd': ()=>{ second = !second; },
    deg: ()=>{ deg = !deg; },
    ln: ()=> setCurrent(Math.log(parseFloat(current))),
    log: ()=> setCurrent(Math.log10(parseFloat(current))),
    sin: ()=> setCurrent(Math.sin(toRad(parseFloat(current)))),
    cos: ()=> setCurrent(Math.cos(toRad(parseFloat(current)))),
    tan: ()=> setCurrent(Math.tan(toRad(parseFloat(current)))),
    asin: ()=> setCurrent(fromRad(Math.asin(parseFloat(current)))),
    acos: ()=> setCurrent(fromRad(Math.acos(parseFloat(current)))),
    atan: ()=> setCurrent(fromRad(Math.atan(parseFloat(current)))),
    pow2: ()=> setCurrent(Math.pow(parseFloat(current),2)),
    sqrt: ()=> setCurrent(Math.sqrt(parseFloat(current))),
    pi: ()=> inputConst(Math.PI),
    e: ()=> inputConst(Math.E),
    pow: ()=>{ stored=parseFloat(current); lastOp='pow'; justEvaluated=false; current='0'; updateDisplay(); },
    cbrt: ()=> setCurrent(Math.cbrt(parseFloat(current))),
    lparen: ()=>{ current=current+'('; updateDisplay(); },
    rparen: ()=>{ current=current+')'; updateDisplay(); },
    inv: ()=> setCurrent(1/parseFloat(current)),
    fact: ()=> setCurrent((()=>{ let n=Math.floor(parseFloat(current)); if(n<0) return NaN; let r=1; for(let i=2;i<=n;i++) r*=i; return r; })())
  };

  sciGrid.querySelectorAll('button').forEach(btn=>{
    const fn=btn.dataset.fn;
    btn.addEventListener('click', ()=>{ const a=sciActions[fn]; if(a) a(); });
  });

  const oldEvaluate = evaluate;
  evaluate = function(){
    if (lastOp === 'pow'){
      const x = stored, y = parseFloat(current);
      const res = Math.pow(x,y);
      ans = res; setCurrent(res); stored=null; lastOp=null; return;
    }
    if (/[()πe]/.test(current)){
      try{
        const safe=current.replace(/π/g,`${Math.PI}`).replace(/e/g,`${Math.E}`);
        if(/^[0-9+\-*/().\sEPIeπ]+$/.test(current.replace(/[÷×−]/g,''))){
          const js=safe.replace(/÷/g,'/').replace(/×/g,'*').replace(/−/g,'-');
          const res=Function('"use strict"; return ('+js+');')();
          ans=res; setCurrent(res); return;
        }
      }catch(e){}
    }
    oldEvaluate();
  };

  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('./sw.js?v=7').then(reg=>{
        if (reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
      }).catch(()=>{});
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ location.reload(); });
    });
  }
</script>
</body>
</html>
